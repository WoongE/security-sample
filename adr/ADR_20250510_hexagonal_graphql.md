# ADR: 헥사고날 아키텍처를 적용한 GraphQL API 설계 및 구현

## 상태

채택됨(2025-05-10)

## 맥락

닥터나우 재팬의 서비스 확장을 위해 새로운 백엔드 API 아키텍처가 필요합니다. 기존 시스템은 REST API를 사용하고 있으나, 클라이언트의 다양한 요구사항과 유연한 데이터 조회를 지원하기 위해 GraphQL 도입을 검토했습니다. 또한 코드베이스의 유지보수성과 테스트 용이성을 높이기 위한 아키텍처 패턴 선택이 필요했습니다.

주요 고려 사항:
1. 시스템 확장성과 유지보수성 향상
2. 프론트엔드 요구사항에 유연하게 대응
3. 보안 요구사항 충족 (JWT 기반 인증/인가)
4. 기술 스택 현대화
5. 개발 팀의 생산성 향상

## 결정

다음 기술 및 아키텍처 패턴을 적용하기로 결정했습니다:

1. **헥사고날 아키텍처** 적용
2. **Kotlin**을 주요 언어로 사용
3. **Spring Boot 3.x** 기반의 백엔드 개발
4. **Spring GraphQL**을 API 레이어로 사용
5. **Spring Security**와 **JWT**를 인증/인가 메커니즘으로 사용
6. **Kotlin Exposed**를 ORM으로 채택

## 결정 이유

### 1. 헥사고날 아키텍처 채택

헥사고날 아키텍처(포트 및 어댑터 패턴)는 도메인 로직을 외부 의존성으로부터 분리하여 핵심 비즈니스 로직의 유지보수성과 테스트 용이성을 높입니다.

**장점:**
- 도메인 로직이 데이터베이스, 프레임워크 등 외부 의존성과 분리되어 순수성 유지
- 테스트 용이성 향상 (모킹이 간편함)
- 기술 스택 교체가 용이 (어댑터만 교체하면 됨)
- 도메인 관점에서 개발에 집중 가능

**특징:**
- 도메인 모델 (순수한 코틀린 데이터 클래스)
- 포트 (인터페이스를 통한 도메인 경계 정의)
- 어댑터 (외부 시스템 연동 구현체)
- 포트를 통한 의존성 역전 원칙 적용

### 2. JPA 대신 Kotlin Exposed 사용

JPA는 자바 생태계에서 표준이지만, 헥사고날 아키텍처와 함께 사용할 때 몇 가지 문제점이 있었습니다. 특히 JPA 엔티티와 도메인 모델의 분리는 코드 중복과 매퍼 오버헤드로 이어졌습니다.

**Kotlin Exposed의 장점:**
- 코틀린 DSL을 활용한 타입 안전한 SQL 쿼리
- 도메인 모델을 순수하게 유지 (JPA 어노테이션 불필요)
- 가벼운 ORM으로 성능상 이점
- 명시적인 SQL 제어로 쿼리 최적화가 용이함
- 도메인 모델과 데이터베이스 스키마 간의 분리 명확

### 3. GraphQL API 설계에서의 스키마 퍼스트 vs 코드 퍼스트

Spring GraphQL은 스키마 퍼스트 접근법을 사용합니다. 이것은 `.graphqls` 파일로 API 스키마를 먼저 정의하고, 이를 구현하는 방식입니다.

**스키마 퍼스트(Spring GraphQL):**
- 컨트랙트 중심 설계 지원
- 프론트엔드와 백엔드 간 명확한 API 계약
- 언어 독립적인 API 정의
- API 중심의 개발 접근법

**코드 퍼스트(예: graphql-kotlin):**
- 백엔드 개발자에게 더 친숙함
- 컴파일 타임 타입 안전성
- 코드와 스키마의 자동 동기화
- 코틀린의 타입 시스템 활용 가능

현재는 스프링 생태계 통합을 위해 Spring GraphQL을 채택했지만, 추후 프로젝트에서 graphql-kotlin 또는 Netflix DGS 같은 코드 퍼스트 접근법의 도입을 고려할 수 있습니다.

### 4. JWT를 통한 보안 구현

JWT(JSON Web Token)를 사용한 인증 메커니즘은 RESTful API와 GraphQL API 모두에서 잘 작동하며, 특히 상태가 없는(stateless) 아키텍처에 적합합니다.

**장점:**
- 서버 측 세션 저장소 불필요
- 수평적 확장에 용이
- 토큰 기반 접근으로 인증 정보 교환이 간편함
- GraphQL의 단일 엔드포인트 아키텍처와 잘 어울림

## 결과

이러한 아키텍처 결정은 다음과 같은 결과로 이어질 것으로 예상됩니다:

### 긍정적 결과
- **유지보수성 향상**: 도메인 로직이 기술적 세부사항과 분리되어 비즈니스 로직의 수정이 용이
- **테스트 용이성**: 도메인 로직과 어댑터를 독립적으로 테스트할 수 있음
- **기술 스택 유연성**: 필요시 데이터베이스, 웹 프레임워크 등을 교체하기 쉬움
- **개발 생산성**: 코틀린의 표현력과 Exposed의 DSL로 코드의 간결성 확보
- **API 유연성**: GraphQL을 통한 유연한 데이터 검색 및 조회 지원

### 부정적 결과
- **학습 곡선**: 헥사고날 아키텍처, GraphQL, Exposed 등 새로운 개념과 기술의 학습 필요
- **초기 개발 오버헤드**: 아키텍처 설계와 인프라 설정에 초기 시간 투자 필요
- **과잉 설계 위험**: 작은 프로젝트에서는 헥사고날 아키텍처가 과도할 수 있음
- **프로젝트 복잡도 증가**: 레이어와 추상화 계층의 추가로 인한 코드베이스 복잡도 증가

## 대안

다음 대안들을 검토했지만 채택하지 않았습니다:

1. **전통적인 3계층 아키텍처**
   - 간단하고 익숙하나, 도메인 로직과 인프라 코드의 결합도가 높음
   - 테스트와 유지보수가 상대적으로 어려움

2. **CQRS 패턴**
   - 읽기/쓰기 모델 분리로 확장성이 좋으나 초기 복잡도가 높음
   - 현재 프로젝트 규모에서는 오버 엔지니어링이 될 수 있음

3. **JPA 사용**
   - Java 생태계 표준이나 헥사고날 아키텍처와 함께 사용 시 매퍼 오버헤드 발생
   - 도메인 모델의 순수성을 유지하기 어려움

4. **REST API**
   - 표준적이고 익숙하나, 클라이언트의 다양한 데이터 요구사항 충족이 어려움
   - Over-fetching, Under-fetching 문제 존재

## 구현 노트

### 구현 범위
- 사용자 인증 (회원가입/로그인)
- JWT 기반 인증 및 권한 처리
- GraphQL 리졸버 구현
- Exposed로 데이터 접근 계층 구현

### 주요 디렉토리 구조
```
src/main/kotlin/kim/wonung/security_sample
  ├─ domain
  │   ├─ model          # 도메인 모델 클래스
  │   └─ port           # 포트 인터페이스
  ├─ application
  │   └─ service        # 애플리케이션 서비스 (유스케이스)
  └─ adapter
      ├─ inbound        # 인바운드 어댑터 (API)
      │   ├─ graphql    # GraphQL 리졸버
      │   └─ security   # 보안 구성
      └─ outbound       # 아웃바운드 어댑터
          ├─ persistence # 영속성 어댑터
          └─ security    # 보안 어댑터
```

### 핵심 구현 사항
1. 순수한 도메인 모델을 기반으로 코드 작성
2. 인터페이스를 통한 의존성 역전 원칙 적용
3. Exposed를 사용한 타입 안전한 데이터 액세스
4. GraphQL 리졸버에서 Spring Security 통합
5. 도메인 서비스와 애플리케이션 서비스의 분리

## 교훈 및 향후 고려사항

### 교훈
- 헥사고날 아키텍처와 ORM의 조합 시 모델 중복과 매퍼 오버헤드를 고려해야 함
- GraphQL과 Spring Security 통합 시 서블릿 기반 웹 환경이 필요함
- 스키마 퍼스트와 코드 퍼스트 접근법은 각각 장단점이 있으며 프로젝트 특성에 맞게 선택 필요

### 향후 고려사항
- 대규모 프로젝트로 확장 시 모듈화 전략 필요
- 성능 모니터링 및 최적화 방안 고려
- 코드 첫 접근 방식(Netflix DGS, GraphQL Kotlin)의 도입 검토
- API 버전 관리 전략 수립
- 배치 작업 및 분산 시스템 통합 방안 고려

## 참고 자료
- [헥사고날 아키텍처](https://alistair.cockburn.us/hexagonal-architecture/)
- [Kotlin Exposed](https://github.com/JetBrains/Exposed)
- [Spring for GraphQL](https://docs.spring.io/spring-graphql/docs/current/reference/html/)
- [GraphQL Kotlin](https://opensource.expediagroup.com/graphql-kotlin/docs/)
- [Spring Security](https://docs.spring.io/spring-security/reference/)

---

이 문서는 2025-05-10 개발 계획을 기반으로 작성되었으며, 실제 구현 과정에서 추가적인 인사이트가 반영될 수 있습니다.